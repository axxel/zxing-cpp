package main

import (
    "bufio"
    "bytes"
    "fmt"
    "os"
    "path/filepath"
    "regexp"
    "sort"
    "strconv"
    "strings"
)

type formatDef struct {
    Name  string
    Value uint16
}

func main() {
    repoRoot := filepath.Clean(filepath.Join(mustCwd(), "..", ".."))
    headerPath := filepath.Join(repoRoot, "core", "src", "BarcodeFormat.h")

    defs, err := parseBarcodeFormats(headerPath)
    if err != nil {
        die(err)
    }

    outPath := filepath.Join(repoRoot, "wrappers", "go", "zxingcpp", "barcodeformat_gen.go")
    if err := writeGo(defs, outPath, headerPath); err != nil {
        die(err)
    }
}

func mustCwd() string {
    cwd, err := os.Getwd()
    if err != nil {
        die(err)
    }
    return cwd
}

func die(err error) {
    fmt.Fprintln(os.Stderr, err)
    os.Exit(1)
}

var reX = regexp.MustCompile(`^\s*X\(\s*([A-Za-z0-9_]+)\s*,\s*'([^']*)'\s*,\s*'([^']*)'\s*,`)

func parseBarcodeFormats(path string) ([]formatDef, error) {
    f, err := os.Open(path)
    if err != nil {
        return nil, err
    }
    defer f.Close()

    var defs []formatDef
    s := bufio.NewScanner(f)
    for s.Scan() {
        line := s.Text()
        m := reX.FindStringSubmatch(line)
        if m == nil {
            continue
        }
        name := m[1]
        sym, err := parseChar(m[2])
        if err != nil {
            return nil, fmt.Errorf("%s: parsing SYM for %s: %w", path, name, err)
        }
        varc, err := parseChar(m[3])
        if err != nil {
            return nil, fmt.Errorf("%s: parsing VAR for %s: %w", path, name, err)
        }
        value := uint16(sym) | (uint16(varc) << 8)
        defs = append(defs, formatDef{Name: name, Value: value})
    }
    if err := s.Err(); err != nil {
        return nil, err
    }

    // Keep output stable.
    sort.Slice(defs, func(i, j int) bool { return defs[i].Name < defs[j].Name })
    return defs, nil
}

func parseChar(tok string) (byte, error) {
    // tok is the inside of a C character literal captured without surrounding quotes.
    // Common values: "*", " ", "F", "1".
    if tok == "" {
        return 0, fmt.Errorf("empty char literal")
    }
    if tok[0] != '\\' {
        return tok[0], nil
    }
    // Handle minimal escape set needed for this header.
    if len(tok) == 2 {
        switch tok[1] {
        case '0':
            return 0, nil
        case 'n':
            return '\n', nil
        case 'r':
            return '\r', nil
        case 't':
            return '\t', nil
        case '\\':
            return '\\', nil
        case '\'':
            return '\'', nil
        }
    }
    if strings.HasPrefix(tok, "\\x") {
        b, err := strconv.ParseUint(tok[2:], 16, 8)
        if err != nil {
            return 0, err
        }
        return byte(b), nil
    }
    return 0, fmt.Errorf("unsupported escape: %q", tok)
}

func writeGo(defs []formatDef, outPath, headerPath string) error {
    var b bytes.Buffer
    fmt.Fprintf(&b, "// Code generated by wrappers/go/internal/gen from %s; DO NOT EDIT.\n", filepath.ToSlash(headerPath))
    b.WriteString("\npackage zxingcpp\n\n")
    b.WriteString("//go:generate go run ../internal/gen\n\n")
    b.WriteString("// BarcodeFormat identifies a barcode format/symbology or a filter/group (e.g. AllReadable).\n")
    b.WriteString("//\n")
    b.WriteString("// Values are kept in sync with core/src/BarcodeFormat.h.\n\n")
    fmt.Fprintln(&b, "const (")
    fmt.Fprintln(&b, "\tBarcodeFormatInvalid BarcodeFormat = 0xFFFF")
    for _, d := range defs {
        fmt.Fprintf(&b, "\tBarcodeFormat%-20s BarcodeFormat = 0x%04X\n", d.Name, d.Value)
    }
    fmt.Fprintln(&b, ")")

    // Write file only if changed to avoid needless churn.
    existing, _ := os.ReadFile(outPath)
    if bytes.Equal(existing, b.Bytes()) {
        return nil
    }
    if err := os.MkdirAll(filepath.Dir(outPath), 0o755); err != nil {
        return err
    }
    return os.WriteFile(outPath, b.Bytes(), 0o644)
}

